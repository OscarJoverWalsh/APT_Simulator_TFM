

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Parsers &mdash; caldera  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Relationships" href="Relationships.html" />
    <link rel="prev" title="Plugin library" href="Plugin-library.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html">
          

          
            
            <img src="_static/caldera-logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Usage Guides</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Installing-CALDERA.html">Installing CALDERA</a></li>
<li class="toctree-l1"><a class="reference internal" href="Getting-started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="Learning-the-terminology.html">Learning the terminology</a></li>
<li class="toctree-l1"><a class="reference internal" href="Basic-Usage.html">Basic Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="Server-Configuration.html">Server Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="Plugin-library.html">Plugin library</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Parsers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#linking-parsers-to-an-ability">Linking Parsers to an Ability</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Relationships.html">Relationships</a></li>
<li class="toctree-l1"><a class="reference internal" href="Requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="Objectives.html">Objectives</a></li>
<li class="toctree-l1"><a class="reference internal" href="Operation-Results.html">Operation Results</a></li>
<li class="toctree-l1"><a class="reference internal" href="Initial-Access-Attacks.html">Initial Access Attacks</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lateral-Movement-Guide.html">Windows Lateral Movement Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="Dynamically-Compiled-Payloads.html">Dynamically-Compiled Payloads</a></li>
<li class="toctree-l1"><a class="reference internal" href="Exfiltration.html">Exfiltration</a></li>
<li class="toctree-l1"><a class="reference internal" href="Sandcat-Peer-to-Peer.html">Peer-to-Peer Proxy Functionality for Sandcat Agents</a></li>
<li class="toctree-l1"><a class="reference internal" href="C2-Tunneling.html">C2 Communications Tunneling</a></li>
<li class="toctree-l1"><a class="reference internal" href="Uninstalling-CALDERA.html">Uninstall CALDERA</a></li>
<li class="toctree-l1"><a class="reference internal" href="Troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="resources.html">Resources</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Plugin Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="plugins/sandcat/Sandcat-Details.html">Sandcat Plugin Details</a></li>
<li class="toctree-l1"><a class="reference internal" href="plugins/stockpile/Exfiltration-How-Tos.html">Exfiltration Scenarios and Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="plugins/stockpile/Exfiltration-How-Tos.html#an-example">An Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="plugins/stockpile/Exfiltration-How-Tos.html#wrap-up">Wrap-up</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="The-REST-API.html">The REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="How-to-Build-Plugins.html">How to Build Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="How-to-Build-Planners.html">How to Build Planners</a></li>
<li class="toctree-l1"><a class="reference internal" href="How-to-Build-Agents.html">How to Build Agents</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Core System API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="_generated/modules.html">app</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">caldera</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Parsers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/Parsers.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="parsers">
<h1>Parsers<a class="headerlink" href="#parsers" title="Permalink to this heading">¶</a></h1>
<p>CALDERA uses parsers to extract facts from command output. A common use case is to allow
operations to take gathered information and feed it into future abilities and decisions -
for example, a discovery ability that looks for sensitive files can output file paths, which
will then be parsed into file path facts, and a subsequent ability can use those file paths
to stage the sensitive files in a staging directory.</p>
<p>Parsers can also be used to create facts with relationships linked between them - this allows
users to associate facts together, such as username and password facts.</p>
<p>Under the hood, parsers are python modules that get called when the agent sends command output
to the CALDERA server and certain conditions are met:</p>
<ul class="simple">
<li><p>If the corresponding ability has a specified parser associated with the command,
the parser module will be loaded and used to parse out any facts from the output.
This will occur even if the agent ran the command outside of an operation</p></li>
<li><p>If the agent ran the command as part of an operation, but the corresponding ability does not
have any specified parsers associated with the command, CALDERA will check if the operation
was configured to use default parsers. If so, any default parsers loaded within CALDERA will
be used to parse out facts from the output. Otherwise, no parsing occurs.</p></li>
<li><p>If the agent ran the command outside of an operation, but the corresponding ability does not
have any specified parsers associated with the command, CALDERA will use its default parsers
to parse the output.</p></li>
</ul>
<p>Non-default Parser python modules are typically stored in individual plugins, such as <code class="docutils literal notranslate"><span class="pre">stockpile</span></code>, in the
plugin’s <code class="docutils literal notranslate"><span class="pre">app/parsers/</span></code> directory. For instance, if you look in <code class="docutils literal notranslate"><span class="pre">plugins/stockpile/app/parsers</span></code>,
you can see a variety of parsers that are provided out-of-the-box.</p>
<p>Default parsers are located in the core CALDERA repo, under <code class="docutils literal notranslate"><span class="pre">app/learning</span></code>.
Two example modules are <code class="docutils literal notranslate"><span class="pre">p_ip.py</span></code> and <code class="docutils literal notranslate"><span class="pre">p_path.py</span></code>, which are used to parse IP addresses and file
paths, respectively. Note that the default parsers have a different location due to their
association with the learning service.</p>
<div class="section" id="linking-parsers-to-an-ability">
<h2>Linking Parsers to an Ability<a class="headerlink" href="#linking-parsers-to-an-ability" title="Permalink to this heading">¶</a></h2>
<p>To associate specific parsers to an ability command, use the <code class="docutils literal notranslate"><span class="pre">parsers</span></code> keyword in the yaml file
within the executor section (see the below example).</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="nt">darwin</span><span class="p">:</span>
<span class="w">      </span><span class="nt">sh</span><span class="p">:</span>
<span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">find /Users -name &#39;*.#{file.sensitive.extension}&#39; -type f -not -path &#39;*/\.*&#39; -size -500k 2&gt;/dev/null | head -5</span>
<span class="w">        </span><span class="nt">parsers</span><span class="p">:</span>
<span class="w">          </span><span class="nt">plugins.stockpile.app.parsers.basic</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">source</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">host.file.path</span>
<span class="w">              </span><span class="nt">edge</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">has_extension</span>
<span class="w">              </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">file.sensitive.extension</span>
</pre></div>
</div>
<p>Note that the parsers value is a nested dictionary whose key is the Python module import path
of the parser to reference; in this case, <code class="docutils literal notranslate"><span class="pre">plugins.stockpile.app.parsers.basic</span></code> for the Parser
located in <code class="docutils literal notranslate"><span class="pre">plugins/stockpile/app/parsers/basic.py</span></code>.
The value of this inner dict is a list of fact mappings that tell the Parser what facts and
relationships to save based on the output. In this case, we only have one mapping in the list.</p>
<p>Each mapping consists of the following:</p>
<ul class="simple">
<li><p><strong>Source</strong> (required): A fact to create for any matches from the parser</p></li>
<li><p><strong>Edge</strong> (optional): A relationship between the source and target. This should be a string.</p></li>
<li><p><strong>Target</strong> (optional): A fact to create which the source connects to.</p></li>
</ul>
<p>In the above example, the <code class="docutils literal notranslate"><span class="pre">basic</span></code> parser will take each line of output from the <code class="docutils literal notranslate"><span class="pre">find</span></code> command,
save it as a <code class="docutils literal notranslate"><span class="pre">host.file.path</span></code> fact, and link it to the <code class="docutils literal notranslate"><span class="pre">file.sensitive.extension</span></code> fact used in
the command with the <code class="docutils literal notranslate"><span class="pre">has_extension</span></code> edge. For instance, if the command was run using a
<code class="docutils literal notranslate"><span class="pre">file.sensitive.extension</span></code> value of <code class="docutils literal notranslate"><span class="pre">docx</span></code> and the <code class="docutils literal notranslate"><span class="pre">find</span></code> command returned <code class="docutils literal notranslate"><span class="pre">/path/to/mydoc.docx</span></code>
and <code class="docutils literal notranslate"><span class="pre">/path/to/sensitive.docx</span></code>, the parser would generate the following facts and relationships:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">/path/to/mydoc.docx</span></code> &lt;- <code class="docutils literal notranslate"><span class="pre">has_extension</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">docx</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/path/to/sensitive.docx</span></code> &lt;- <code class="docutils literal notranslate"><span class="pre">has_extension</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">docx</span></code></p></li>
</ul>
<p>Note that only one parser can be linked to a command at a time, though a single parser can be used to
generate multiple facts, as in our hypothetical example above. Also note that the parser only works
for the associated command executor, so you can use different parsers for different executors and
even different platforms.</p>
<p>The example below shows a more complicated parser - the <code class="docutils literal notranslate"><span class="pre">katz</span></code> parser in the <code class="docutils literal notranslate"><span class="pre">stockpile</span></code> plugin.
This example has multiple fact mappings for a single parser, since we want to extract different
types of information from the Mimikatz output - in particular, the password and password hash
information.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="nt">platforms</span><span class="p">:</span>
<span class="w">    </span><span class="nt">windows</span><span class="p">:</span>
<span class="w">      </span><span class="nt">psh</span><span class="p">:</span>
<span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">Import-Module .\invoke-mimi.ps1;</span>
<span class="w">          </span><span class="no">Invoke-Mimikatz -DumpCreds</span>
<span class="w">        </span><span class="nt">parsers</span><span class="p">:</span>
<span class="w">          </span><span class="nt">plugins.stockpile.app.parsers.katz</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">source</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">domain.user.name</span>
<span class="w">            </span><span class="nt">edge</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">has_password</span>
<span class="w">            </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">domain.user.password</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">source</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">domain.user.name</span>
<span class="w">            </span><span class="nt">edge</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">has_hash</span>
<span class="w">            </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">domain.user.ntlm</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">source</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">domain.user.name</span>
<span class="w">            </span><span class="nt">edge</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">has_hash</span>
<span class="w">            </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">domain.user.sha1</span>
<span class="w">        </span><span class="nt">payloads</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">invoke-mimi.ps1</span>
</pre></div>
</div>
<p>This time, we are using <code class="docutils literal notranslate"><span class="pre">plugins.stockpile.app.parsers.katz</span></code>, which will take the output
from the <code class="docutils literal notranslate"><span class="pre">Invoke-Mimikatz</span> <span class="pre">-DumpCreds</span></code> command and apply the 3 specified mappings when parsing
the output. Note that in all 3 mappings, the source fact is the same: <code class="docutils literal notranslate"><span class="pre">domain.user.name</span></code>, but
the relationship edges and target facts are all different, based on what kind of information we
want to save. The resulting facts, assuming the command was successful and provided the desired
information, will include the username, password, NTLM hash, and SHA1 hash, all linked together
with the appropriate relationship edges.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="Relationships.html" class="btn btn-neutral float-right" title="Relationships" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="Plugin-library.html" class="btn btn-neutral float-left" title="Plugin library" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2023, The MITRE Corporation

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>